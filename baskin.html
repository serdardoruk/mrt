<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raid Planner</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #f6f8fc, #eef2f7); min-height: 100vh; color: #0f172a; padding: 20px; margin-top: 60px; }
.top-nav { position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #0f172a; display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.3); padding: 0 16px; }
.top-nav a { display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 8px; text-decoration: none; color: #94a3b8; font-weight: 600; font-size: 13px; transition: all 0.2s; background: #1e293b; }
.top-nav a:hover { background: rgba(255,255,255,0.15); color: #f8fafc; }
.top-nav a.active { background: #2563eb; color: #fff; }
.omerta-timer { position: absolute; left: 12px; color: #fbbf24; font-family: monospace; font-size: 14px; font-weight: 700; }
.logout-btn { position: absolute !important; right: 12px; }
.page { max-width: 550px; margin: 0 auto; }
h1 { text-align: center; margin-bottom: 12px; font-size: 20px; }
.update-time { text-align: center; color: #64748b; font-size: 11px; margin-bottom: 12px; }
.controls { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; justify-content: center; }
.search-box { padding: 8px 10px; border-radius: 6px; border: 1px solid #cbd5e1; background: #fff; color: #0f172a; font-size: 12px; width: 180px; }
.search-box:focus { outline: none; border-color: #2563eb; }
.add-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; }
.add-btn:hover { background: #1d4ed8; }
.player-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
.player-dropdown.show { display: block; }
.player-option { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 8px; }
.player-option:hover { background: #f1f5f9; }
.player-option:last-child { border-bottom: none; }
.search-wrap { position: relative; }
.baskin-list { background: #fff; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.baskin-item { display: flex; flex-direction: column; gap: 4px; padding: 8px 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 6px; border: 1px solid #e2e8f0; }
.baskin-item:last-child { margin-bottom: 0; }
.baskin-header { display: flex; align-items: center; justify-content: space-between; gap: 6px; }
.enemy-info { flex: 1; display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
.enemy-name { font-weight: 700; font-size: 13px; color: #0f172a; }
.enemy-meta { color: #64748b; font-size: 10px; }
.stats-block { display: flex; gap: 4px; margin-left: 4px; padding: 4px 6px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; align-items: flex-start; }
.stat-col { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.stats-inline { display: flex; gap: 2px; align-items: center; }
.stats-group { display: flex; gap: 1px; padding: 1px 2px; border-radius: 3px; background: rgba(0,0,0,0.03); }
.stats-group.bg { border-left: 2px solid #f59e0b; }
.stat-btn { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; background: #fff; }
.stat-btn.active { border-color: #22c55e; background: #dcfce7; color: #16a34a; }
.stat-btn.inactive { opacity: 0.7; background: #f1f5f9; color: #94a3b8; border: 1px dashed #cbd5e1; }
.stat-btn.inactive:hover { opacity: 1; background: #e2e8f0; }
.stat-btn.suit.active { border-color: #3b82f6; background: #dbeafe; color: #1d4ed8; }
.stat-btn.car.active { border-color: #f59e0b; background: #fef3c7; color: #b45309; }
.stat-btn.blood.active { border-color: #ef4444; background: #fee2e2; color: #dc2626; }
.city-select { padding: 2px 4px; border-radius: 3px; font-size: 10px; font-weight: 600; border: 1px solid #cbd5e1; background: #fff; color: #0f172a; cursor: pointer; }
.city-select:focus { outline: none; border-color: #2563eb; }
.city-row { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f1f5f9; border-radius: 6px; margin-top: 4px; flex-wrap: wrap; }
.city-label { font-size: 11px; color: #64748b; }
.fly-status { display: flex; align-items: center; gap: 6px; margin-left: auto; }
.fly-timer { font-size: 10px; font-weight: 700; color: #ef4444; font-family: monospace; }
.can-fly { padding: 2px 5px; border-radius: 3px; font-size: 9px; font-weight: 600; }
.can-fly.yes { background: #22c55e; color: #fff; }
.can-fly.no { background: #ef4444; color: #fff; }
.timers-row { display: flex; gap: 4px; padding: 2px 0; flex-wrap: wrap; }
.timer-item { display: flex; align-items: center; gap: 2px; padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: 600; font-family: monospace; }
.timer-item.fly { background: #dbeafe; color: #1d4ed8; }
.timer-item.sh { background: #fce7f3; color: #be185d; }
.timer-item.blood { background: #fee2e2; color: #dc2626; }
.timer-inline { display: flex; align-items: center; gap: 1px; font-size: 8px; font-weight: 600; font-family: monospace; background: #fef3c7; border-radius: 3px; padding: 1px 2px; }
.timer-text { cursor: pointer; padding: 0 2px; }
.timer-text:hover { text-decoration: underline; }
.timer-adj { cursor: pointer; width: 12px; height: 12px; display: flex; align-items: center; justify-content: center; border-radius: 2px; font-size: 9px; font-weight: 700; }
.timer-adj:hover { background: rgba(0,0,0,0.1); }
.shooter-section { display: flex; flex-direction: column; gap: 2px; padding-left: 12px; border-left: 2px solid #22c55e; margin-left: 4px; }
.shooter-row { display: flex; align-items: center; gap: 4px; padding: 2px 4px; background: rgba(34,197,94,0.1); border-radius: 3px; }
.shooter-pos { font-weight: 700; font-size: 10px; color: #0f172a; }
.shooter-name { font-weight: 600; color: #16a34a; font-size: 11px; }
.shooter-meta { color: #64748b; font-size: 9px; }
.shooter-bg { display: flex; gap: 2px; align-items: center; margin-left: auto; opacity: 0.7; flex-wrap: wrap; }
.shooter-bg:hover { opacity: 1; }
.shooter-bg-item { padding: 1px 4px; border-radius: 3px; font-size: 8px; font-weight: 600; cursor: pointer; user-select: none; border: 1px solid; white-space: nowrap; }
.shooter-bg-item.inactive { background: #f8fafc; border: 1px dashed #e2e8f0; color: #94a3b8; font-size: 7px; }
.shooter-bg-item:hover { opacity: 0.8; }
.shooter-result { width: 60px; padding: 2px 4px; border-radius: 3px; border: 1px solid #cbd5e1; font-size: 9px; background: #f8fafc; }
.shooter-result:focus { outline: none; border-color: #2563eb; background: #fff; }
.target-bg-count { cursor: pointer; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; background: #fef3c7; border: 1px solid #fbbf24; user-select: none; }
.target-bg-count:hover { background: #fde68a; }
.target-bg-count.has-dead { background: #fee2e2; border-color: #f87171; color: #dc2626; }
.bg-presets { display: flex; gap: 2px; margin-left: 4px; }
.bg-presets button { width: 18px; height: 18px; border: 1px solid #cbd5e1; background: #fff; border-radius: 3px; cursor: pointer; font-size: 10px; padding: 0; }
.bg-presets button:hover { background: #f1f5f9; }
.shooter-bg-label { font-size: 9px; }
.drag-handle { cursor: grab; color: #94a3b8; font-size: 10px; user-select: none; padding: 0 2px; }
.drag-handle:active { cursor: grabbing; }
.shooter-row.dragging { opacity: 0.4; background: #dbeafe; }
.shooter-row.drag-over { border-top: 2px solid #2563eb; }
.shooter-hits { display: flex; gap: 4px; align-items: center; margin-left: 6px; }
.hit-select { padding: 4px 6px; border-radius: 4px; font-size: 12px; font-weight: 600; border: 1px solid #cbd5e1; background: #f8fafc; color: #64748b; cursor: pointer; }
.hit-select:focus { outline: none; border-color: #2563eb; }
.hit-select.bg { width: 50px; }
.hit-select:not([value="0"]) { background: #fee2e2; border-color: #f87171; color: #dc2626; }
.hit-btn { padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: 600; cursor: pointer; border: 1px solid #cbd5e1; background: #f8fafc; color: #64748b; }
.hit-btn:hover { background: #e2e8f0; }
.hit-btn.active { background: #dc2626; border-color: #dc2626; color: #fff; }
.hit-btn.active.suit { background: #2563eb; border-color: #2563eb; }
.hit-btn.active.car { background: #f59e0b; border-color: #f59e0b; }
.hit-btn.active.blood { background: #be123c; border-color: #be123c; }
.shooter-remove { cursor: pointer; color: #ef4444; font-size: 11px; opacity: 0.7; }
.shooter-remove:hover { opacity: 1; }
.add-shooter-btn { padding: 3px 8px; border-radius: 4px; border: 1px dashed #94a3b8; background: transparent; color: #64748b; cursor: pointer; font-size: 10px; }
.add-shooter-btn:hover { border-color: #2563eb; color: #2563eb; }
.remove-enemy { color: #ef4444; cursor: pointer; font-size: 14px; opacity: 0.6; }
.remove-enemy:hover { opacity: 1; }
.empty-state { text-align: center; padding: 20px; color: #64748b; font-size: 12px; }
.pos-badge { padding: 1px 4px; border-radius: 3px; font-weight: 700; font-size: 10px; }
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; }
.modal-overlay.show { display: flex; }
.modal { background: #fff; border-radius: 12px; padding: 20px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.25); border: 1px solid #e2e8f0; }
.modal h3 { margin-bottom: 16px; color: #0f172a; }
.modal-search { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; background: #fff; color: #0f172a; margin-bottom: 12px; }
.modal-list { max-height: 300px; overflow-y: auto; }
.modal-item { padding: 10px; cursor: pointer; border-radius: 6px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
.modal-item:hover { background: #f1f5f9; }
.save-btn { position: fixed; bottom: 20px; right: 20px; padding: 14px 28px; border-radius: 12px; border: none; background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 8px 24px rgba(34,197,94,0.4); }
.save-btn:hover { transform: translateY(-2px); }
.copy-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid #cbd5e1; background: #fff; color: #0f172a; font-weight: 600; cursor: pointer; }
.copy-btn:hover { background: #f1f5f9; }
@media (max-width: 768px) {
    body { margin-top: 0; padding-bottom: 70px; }
    .top-nav { top: auto; bottom: 0; height: 60px; }
    .save-btn { bottom: 80px; }
}
</style>
</head>
<body>
<script>
(function(){
    // Eƒüer iframe i√ßinde deƒüilsek, login kontrol√º yap
    if (window.self === window.top) {
        // Doƒürudan eri≈üim - login kontrol√º
        try {
            if (!sessionStorage.getItem('omerta_user')) {
                window.location.href = 'index.html';
            }
        } catch(e) {
            window.location.href = 'index.html';
        }
    }
})();
</script>



<div id="admin-build-info" style="display:none; position:fixed; bottom:5px; left:5px; background:rgba(0,0,0,0.7); color:#4ade80; padding:4px 8px; border-radius:4px; font-size:10px; font-family:monospace; z-index:9999;">
    üöÄ No commit
</div>
<script>
try{const u=JSON.parse(sessionStorage.getItem('omerta_user')||'{}');if(u.username==='admin')document.getElementById('admin-build-info').style.display='block';}catch(e){}
</script>

<div class="page">
    <h1>üéØ Raid Planner</h1>
    
    <div class="controls">
        <div class="search-wrap">
            <input type="text" class="search-box" id="familySearch" placeholder="üè† Search family (adds all members)...">
            <div class="player-dropdown" id="familyDropdown"></div>
        </div>
        <div class="search-wrap">
            <input type="text" class="search-box" id="enemySearch" placeholder="üë§ Search player...">
            <div class="player-dropdown" id="enemyDropdown"></div>
        </div>
        <button class="copy-btn" onclick="copyBaskinList()">üìã Copy List</button>
    </div>
    
    <div class="baskin-list" id="baskinList">
        <div class="empty-state">No targets added yet. Search and add above.</div>
    </div>
</div>

<div class="modal-overlay" id="shooterModal">
    <div class="modal">
        <h3>Shooter Se√ß</h3>
        <input type="text" class="modal-search" id="shooterSearch" placeholder="Shooter ara...">
        <div class="modal-list" id="shooterList"></div>
    </div>
</div>

<button class="save-btn" onclick="saveState()">üíæ Kaydet</button>

<script>
// Omerta Timer
(function(){function updateOmertaTimer(){const el=document.getElementById('omertaTimer');if(!el)return;const now=new Date();const utc=Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate(),now.getUTCHours(),now.getUTCMinutes(),now.getUTCSeconds());const hours=[0,4,8,12,16,20];const todayMidnight=Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate());let nextOmerta=null;for(let h of hours){const t=todayMidnight+h*3600000;if(t>utc){nextOmerta=t;break;}}if(!nextOmerta)nextOmerta=todayMidnight+24*3600000;const diff=nextOmerta-utc;const m=Math.floor(diff/60000);const s=Math.floor((diff%60000)/1000);el.textContent='‚è± '+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');}updateOmertaTimer();setInterval(updateOmertaTimer,1000);})();

const allPlayers = [{"Name": "Massacre", "Family": "Trueblood", "Rank": "Godfather", "Pos": 16, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024405"}, {"Name": "Butcher", "Family": "Fangtasia", "Rank": "Godfather", "Pos": 12, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023663"}, {"Name": "Lz", "Family": "Pokeball", "Rank": "Godfather", "Pos": 24, "ShieldColor": "", "UserHref": "/user.php?idn=1023897"}, {"Name": "Cleopatra", "Family": "Imperium", "Rank": "First Lady", "Pos": 6, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022611"}, {"Name": "Jeanreno", "Family": "Osman", "Rank": "Godfather", "Pos": 32, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024731"}, {"Name": "Octavianus", "Family": "Pimp", "Rank": "Godfather", "Pos": 14, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022980"}, {"Name": "Nordic", "Family": "Spazzare", "Rank": "Godfather", "Pos": 63, "ShieldColor": "", "UserHref": "/user.php?idn=1024935"}, {"Name": "Uncle", "Family": "Hadzabe", "Rank": "Godfather", "Pos": 10, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022661"}, {"Name": "Notorious", "Family": "Brigada", "Rank": "Godfather", "Pos": 26, "ShieldColor": "", "UserHref": "/user.php?idn=1024109"}, {"Name": "Gambit", "Family": "Imp", "Rank": "Godfather", "Pos": 28, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023427"}, {"Name": "Maggie", "Family": "Chimp", "Rank": "First Lady", "Pos": 21, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022608"}, {"Name": "Beklani", "Family": "Siverek", "Rank": "Godfather", "Pos": 2, "ShieldColor": "", "UserHref": "/user.php?idn=1026417"}, {"Name": "Soth", "Family": "Imperium", "Rank": "Capodecina", "Pos": 35, "ShieldColor": "", "UserHref": "/user.php?idn=1022781"}, {"Name": "Oxbison", "Family": "Spazzare", "Rank": "Capodecina", "Pos": 70, "ShieldColor": "", "UserHref": "/user.php?idn=1022738"}, {"Name": "Hybrid", "Family": "Fangtasia", "Rank": "Capodecina", "Pos": 58, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023367"}, {"Name": "Nitro", "Family": "Gratziano", "Rank": "Capodecina", "Pos": 87, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023496"}, {"Name": "Dixon", "Family": "Imp", "Rank": "Capodecina", "Pos": 22, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022617"}, {"Name": "Gimli", "Family": "Pimp", "Rank": "Capodecina", "Pos": 53, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024671"}, {"Name": "Pars", "Family": "Spazzare", "Rank": "Capodecina", "Pos": 50, "ShieldColor": "", "UserHref": "/user.php?idn=1022910"}, {"Name": "Dictator", "Family": "Imperium", "Rank": "Capodecina", "Pos": 17, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024808"}, {"Name": "Juarez", "Family": "Trueblood", "Rank": "Capodecina", "Pos": 59, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022667"}, {"Name": "Gyokeres", "Family": "Imp", "Rank": "Capodecina", "Pos": 36, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022673"}, {"Name": "Incognito", "Family": "Fangtasia", "Rank": "Capodecina", "Pos": 42, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023406"}, {"Name": "Daemon", "Family": "Pimp", "Rank": "Capodecina", "Pos": 37, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024275"}, {"Name": "Kai", "Family": "Imperium", "Rank": "Capodecina", "Pos": 51, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024561"}, {"Name": "Intake", "Family": "Chimp", "Rank": "Capodecina", "Pos": 71, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022632"}, {"Name": "Primera", "Family": "Fangtasia", "Rank": "Capodecina", "Pos": 57, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1025996"}, {"Name": "Mowgli", "Family": "Pimp", "Rank": "Capodecina", "Pos": 13, "ShieldColor": "", "UserHref": "/user.php?idn=1023179"}, {"Name": "Epa", "Family": "Spazzare", "Rank": "Capodecina", "Pos": 107, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023094"}, {"Name": "Zimojic", "Family": "Trueblood", "Rank": "Capodecina", "Pos": 27, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023849"}, {"Name": "Arteta", "Family": "Imp", "Rank": "Capodecina", "Pos": 60, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1025432"}, {"Name": "Ferrari", "Family": "Brigada", "Rank": "Capodecina", "Pos": 19, "ShieldColor": "", "UserHref": "/user.php?idn=1022911"}, {"Name": "Sitemkar", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 4, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024792"}, {"Name": "Tamamaskim", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 18, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024760"}, {"Name": "Osimhen", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 9, "ShieldColor": "", "UserHref": "/user.php?idn=1022974"}, {"Name": "Cohen", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 20, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024787"}, {"Name": "Vindicta", "Family": "Simp", "Rank": "Bruglione", "Pos": 30, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023531"}, {"Name": "Mandy", "Family": "Imperium", "Rank": "Bruglione", "Pos": 31, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022806"}, {"Name": "Kill", "Family": "Imp", "Rank": "Bruglione", "Pos": 47, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022659"}, {"Name": "Ti", "Family": "Imp", "Rank": "Bruglione", "Pos": 77, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023220"}, {"Name": "Wortex", "Family": "Imp", "Rank": "Bruglione", "Pos": 65, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022613"}, {"Name": "Yilmaz", "Family": "Pokeball", "Rank": "Bruglione", "Pos": 29, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022933"}, {"Name": "Huslia", "Family": "Pimp", "Rank": "Bruglione", "Pos": 123, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022841"}, {"Name": "Prestige", "Family": "Imp", "Rank": "Bruglione", "Pos": 146, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024228"}, {"Name": "Hard", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 46, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024767"}, {"Name": "Duchess", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 3, "ShieldColor": "", "UserHref": "/user.php?idn=1023015"}, {"Name": "Odin", "Family": "Pimp", "Rank": "Bruglione", "Pos": 56, "ShieldColor": "", "UserHref": "/user.php?idn=1024497"}, {"Name": "Mm", "Family": "Simp", "Rank": "Bruglione", "Pos": 151, "ShieldColor": "", "UserHref": "/user.php?idn=1024627"}, {"Name": "Leo", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 5, "ShieldColor": "", "UserHref": "/user.php?idn=1023414"}, {"Name": "Kreon", "Family": "Bs", "Rank": "Bruglione", "Pos": 200, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024662"}, {"Name": "Totti", "Family": "Veterans", "Rank": "Bruglione", "Pos": 15, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023213"}, {"Name": "Snow", "Family": "Gratziano", "Rank": "Bruglione", "Pos": 276, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024207"}, {"Name": "Baloo", "Family": "Imp", "Rank": "Bruglione", "Pos": 144, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024699"}, {"Name": "Len", "Family": "Pimp", "Rank": "Bruglione", "Pos": 120, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022882"}, {"Name": "Cat", "Family": "Newoceans", "Rank": "Bruglione", "Pos": 99, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023662"}, {"Name": "Mes", "Family": "Imperium", "Rank": "Bruglione", "Pos": 8, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023861"}, {"Name": "Abracasey", "Family": "Spaz", "Rank": "Bruglione", "Pos": 124, "ShieldColor": "", "UserHref": "/user.php?idn=1022752"}, {"Name": "Icardi", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 1, "ShieldColor": "", "UserHref": "/user.php?idn=1024040"}, {"Name": "Najdorf", "Family": "Simp", "Rank": "Bruglione", "Pos": 76, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022735"}, {"Name": "Artos", "Family": "Brigada", "Rank": "Bruglione", "Pos": 54, "ShieldColor": "", "UserHref": "/user.php?idn=1022866"}, {"Name": "Astorre", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 143, "ShieldColor": "", "UserHref": "/user.php?idn=1024230"}, {"Name": "Ais", "Family": "Simp", "Rank": "Bruglione", "Pos": 49, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1027340"}, {"Name": "Karl", "Family": "Farmstory", "Rank": "Bruglione", "Pos": 245, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024402"}, {"Name": "Fx", "Family": "Siverek", "Rank": "Bruglione", "Pos": 11, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023309"}, {"Name": "Sinanates", "Family": "Imperium", "Rank": "Bruglione", "Pos": 34, "ShieldColor": "", "UserHref": "/user.php?idn=1024370"}, {"Name": "Helen", "Family": "Pimp", "Rank": "Bruglione", "Pos": 174, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024243"}, {"Name": "Elf", "Family": "Outsiders", "Rank": "Bruglione", "Pos": 55, "ShieldColor": "", "UserHref": "/user.php?idn=1023092"}, {"Name": "Adler", "Family": "Imperium", "Rank": "Bruglione", "Pos": 114, "ShieldColor": "", "UserHref": "/user.php?idn=1022609"}, {"Name": "Ponzi", "Family": "Prestige", "Rank": "Bruglione", "Pos": 162, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024947"}, {"Name": "Umay", "Family": "Imperium", "Rank": "Bruglione", "Pos": 74, "ShieldColor": "", "UserHref": "/user.php?idn=1023187"}, {"Name": "Naish", "Family": "Imperium", "Rank": "Bruglione", "Pos": 41, "ShieldColor": "", "UserHref": "/user.php?idn=1023019"}, {"Name": "Boz", "Family": "Imperium", "Rank": "Bruglione", "Pos": 33, "ShieldColor": "", "UserHref": "/user.php?idn=1022921"}, {"Name": "Dext", "Family": "Imperium", "Rank": "Bruglione", "Pos": 68, "ShieldColor": "", "UserHref": "/user.php?idn=1027183"}, {"Name": "Six", "Family": "Imperium", "Rank": "Bruglione", "Pos": 81, "ShieldColor": "", "UserHref": "/user.php?idn=1024212"}, {"Name": "Demacia", "Family": "Gratziano", "Rank": "Bruglione", "Pos": 302, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024928"}, {"Name": "Sabo", "Family": "Imperium", "Rank": "Bruglione", "Pos": 75, "ShieldColor": "", "UserHref": "/user.php?idn=1022746"}, {"Name": "Kelly", "Family": "Imp", "Rank": "Bruglione", "Pos": 128, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024591"}, {"Name": "Time", "Family": "Gratziano", "Rank": "Bruglione", "Pos": 150, "ShieldColor": "", "UserHref": "/user.php?idn=1024113"}, {"Name": "Mary", "Family": "Gratziano", "Rank": "Bruglione", "Pos": 265, "ShieldColor": "#ff9966", "UserHref": "/user.php?idn=1024278"}, {"Name": "Inara", "Family": "Imperium", "Rank": "Bruglione", "Pos": 131, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022918"}, {"Name": "Javier", "Family": "Simp", "Rank": "Bruglione", "Pos": 223, "ShieldColor": "", "UserHref": "/user.php?idn=1022814"}, {"Name": "Bb", "Family": "Veterans", "Rank": "Bruglione", "Pos": 100, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1023164"}, {"Name": "Tick", "Family": "Pimp", "Rank": "Bruglione", "Pos": 83, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022671"}, {"Name": "Sambata", "Family": "Fangtasia", "Rank": "Bruglione", "Pos": 102, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022915"}, {"Name": "Akada", "Family": "Veterans", "Rank": "Bruglione", "Pos": 238, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024303"}, {"Name": "Shelby", "Family": "Osmanli", "Rank": "Bruglione", "Pos": 168, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022825"}, {"Name": "Bymstf", "Family": "Chimp", "Rank": "Bruglione", "Pos": 67, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022767"}, {"Name": "Macak", "Family": "Brigada", "Rank": "Bruglione", "Pos": 93, "ShieldColor": "", "UserHref": "/user.php?idn=1023988"}, {"Name": "Run", "Family": "Imperium", "Rank": "Bruglione", "Pos": 69, "ShieldColor": "", "UserHref": "/user.php?idn=1022631"}, {"Name": "Tsigalko", "Family": "Strangers", "Rank": "Bruglione", "Pos": 213, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024181"}, {"Name": "Kasaba", "Family": "Veterans", "Rank": "Bruglione", "Pos": 105, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024423"}, {"Name": "Auralpha", "Family": "Newoceans", "Rank": "Bruglione", "Pos": 89, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024678"}, {"Name": "Vyper", "Family": "Pimp", "Rank": "Bruglione", "Pos": 157, "ShieldColor": "", "UserHref": "/user.php?idn=1023396"}, {"Name": "Milo", "Family": "Simp", "Rank": "Bruglione", "Pos": 156, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022834"}, {"Name": "Adonis", "Family": "Chimp", "Rank": "Bruglione", "Pos": 232, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1024933"}, {"Name": "Alonso", "Family": "Imperium", "Rank": "Bruglione", "Pos": 113, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1025012"}, {"Name": "Gypsy", "Family": "Imperium", "Rank": "Bruglione", "Pos": 121, "ShieldColor": "", "UserHref": "/user.php?idn=1027154"}, {"Name": "Carneglia", "Family": "Imperium", "Rank": "Bruglione", "Pos": 158, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022620"}, {"Name": "Hangman", "Family": "Newoceans", "Rank": "Bruglione", "Pos": 127, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022907"}, {"Name": "Saiyan", "Family": "Chimp", "Rank": "Bruglione", "Pos": 96, "ShieldColor": "#ffcc00", "UserHref": "/user.php?idn=1022765"}];
const STORAGE_KEY = 'omerta_baskin_state';

let baskinList = []; // { enemy: {...}, shooters: [{...}, ...] }
let currentEnemyIdx = null;

const RANK_SHORT = {
    'Bruglione': 'Brug',
    'Chief': 'Chief',
    'Local Chief': 'LChief',
    'Assassin': 'Assn',
    'Swindler': 'Swind',
    'Thief': 'Thief',
    'Mobster': 'Mob',
    'Soldier': 'Sold',
    'Picciotto': 'Picc',
    'Associate': 'Assoc',
    'Pickpocket': 'Pick',
    'Shoplifter': 'Shop',
    'Empty-suit': 'Empty',
    'Delivery Boy': 'DBoy',
    'Delivery Girl': 'DGirl'
};
function shortRank(r) { return RANK_SHORT[r] || r; }

function getPosTier(pos) {
    const n = Number(pos);
    if (isNaN(n) || n <= 0 || n > 9000) return { color: '#f3f4f6', icon: '' };
    if (n === 1) return { color: '#78350f', icon: 'üëë' };
    if (n <= 5) return { color: '#92400e', icon: '‚≠ê' };
    if (n <= 20) return { color: '#b45309', icon: '‚ú¶' };
    if (n <= 50) return { color: '#ca8a04', icon: '‚Ä¢' };
    if (n <= 100) return { color: '#eab308', icon: '' };
    if (n <= 200) return { color: '#fbbf24', icon: '' };
    return { color: '#fde68a', icon: '' };
}

function posHtml(pos) {
    const n = Number(pos);
    if (isNaN(n) || n <= 0 || n > 9000) return '';
    const tier = getPosTier(n);
    const isLight = n > 50;
    const textColor = isLight ? '#78350f' : '#fff';
    const icon = tier.icon ? tier.icon + ' ' : '';
    return `<span class="pos-badge" style="background:${tier.color};color:${textColor}">${icon}#${n}</span>`;
}

function renderBaskinList() {
    const container = document.getElementById('baskinList');
    if (!baskinList.length) {
        container.innerHTML = '<div class="empty-state">No targets added yet. Search and add above.</div>';
        return;
    }
    
    container.innerHTML = baskinList.map((item, idx) => {
        const e = item.enemy;
        const st = item.stats || {};
        const shootersHtml = item.shooters.length ? item.shooters.map((s, sIdx) => {
            const sPos = s.Pos && s.Pos < 9000 ? `<span class="shooter-pos">#${s.Pos}</span>` : '';
            const sRank = s.Rank ? shortRank(s.Rank) : '';
            const isFirst = sIdx === 0;
            const isLast = sIdx === item.shooters.length - 1;
            const bgDefaults = [
                {name:'Vic', atk:10, def:0},
                {name:'Lex', atk:10, def:0},
                {name:'Joe', atk:5, def:5},
                {name:'Ike', atk:5, def:5},
                {name:'Ray', atk:0, def:10},
                {name:'Lee', atk:0, def:10}
            ];
            // Handle old array format or new object format
            let bgs = s.bgs || {};
            if (Array.isArray(bgs)) {
                const newBgs = {};
                bgs.forEach((bg, i) => {
                    if (bg && typeof bg === 'object' && bg.atk !== undefined) {
                        newBgs[i] = bg;
                    }
                });
                bgs = newBgs;
                s.bgs = newBgs;
            }
            // Separate active and inactive, active first
            const activeBgs = [];
            const inactiveBgs = [];
            bgDefaults.forEach((info, i) => {
                const bg = bgs[i];
                const isActive = bg !== undefined && bg !== null;
                if (isActive) {
                    // Color spectrum: ATK=red, DEF=blue, mix=purple
                    const atkRatio = bg.atk / 10;
                    const r = Math.round(220 * atkRatio + 37 * (1 - atkRatio));
                    const g = Math.round(38 * atkRatio + 99 * (1 - atkRatio));
                    const b = Math.round(38 * atkRatio + 235 * (1 - atkRatio));
                    const bgColor = `rgba(${r},${g},${b},0.2)`;
                    const borderColor = `rgba(${r},${g},${b},0.6)`;
                    activeBgs.push(`<span class="shooter-bg-item active" style="background:${bgColor};border-color:${borderColor}" onclick="bgClick(event,${idx},${sIdx},${i})" oncontextmenu="disableBg(${idx},${sIdx},${i}); return false;" title="Click:cycle Shift/R:off">${info.name}${bg.atk}/${bg.def}</span>`);
                } else {
                    inactiveBgs.push(`<span class="shooter-bg-item inactive" onclick="enableBg(${idx},${sIdx},${i})" title="${info.name} - Click to enable">${info.name}</span>`);
                }
            });
            const bgsHtml = activeBgs.join('') + inactiveBgs.join('');
            const hits = s.hits || {};
            const bgHit = parseInt(hits.bg) || 0;
            return `<div class="shooter-row" draggable="true" data-enemy="${idx}" data-shooter="${sIdx}" ondragstart="shooterDragStart(event)" ondragover="shooterDragOver(event)" ondrop="shooterDrop(event)" ondragend="shooterDragEnd(event)">
                <span class="drag-handle">‚ãÆ‚ãÆ</span>
                ${sPos}
                <span class="shooter-name">${s.Name}</span>
                <span class="shooter-meta">${s.Family} ${sRank}</span>
                <div class="shooter-bg">
                    ${bgsHtml}
                </div>
                <div class="shooter-hits">
                    <select class="hit-select bg" onchange="setBgHit(${idx},${sIdx},this.value)">
                        <option value="0" ${bgHit==0 ? 'selected' : ''}>BG</option>
                        <option value="1" ${bgHit==1 ? 'selected' : ''}>-1</option>
                        <option value="2" ${bgHit==2 ? 'selected' : ''}>-2</option>
                        <option value="3" ${bgHit==3 ? 'selected' : ''}>-3</option>
                        <option value="4" ${bgHit==4 ? 'selected' : ''}>-4</option>
                        <option value="5" ${bgHit==5 ? 'selected' : ''}>-5</option>
                    </select>
                    <span class="hit-btn suit ${hits.suit ? 'active' : ''}" onclick="toggleHit(${idx},${sIdx},'suit')" title="Suit d√º≈üt√º">üõ°</span>
                    <span class="hit-btn car ${hits.car ? 'active' : ''}" onclick="toggleHit(${idx},${sIdx},'car')" title="Araba patladƒ±">üöó</span>
                    <span class="hit-btn blood ${hits.blood ? 'active' : ''}" onclick="toggleHit(${idx},${sIdx},'blood')" title="Blood d√º≈üt√º">ü©∏</span>
                </div>
                <span class="shooter-remove" onclick="removeShooter(${idx}, ${sIdx})">√ó</span>
            </div>`;
        }).join('') : '';
        
        return `
            <div class="baskin-item">
                <div class="baskin-header">
                    <div class="enemy-info">
                        ${posHtml(e.Pos)}
                        <span class="enemy-name">${e.Name}</span>
                        <span class="enemy-meta">${e.Family} ${e.Rank}</span>
                        <div class="stats-block">
                            <div class="stat-col">
                                <span class="target-bg-count ${(st.bgDead || 0) > 0 ? 'has-dead' : ''}" onclick="cycleTargetBg(${idx})" oncontextmenu="cycleTargetBgBack(${idx}); return false;" title="Click: +1 / RightClick: -1">${(st.bgDead || 0) > 0 ? '-' + st.bgDead + ' BG' : '5 BG'}</span>
                            </div>
                            <div class="stat-col">
                                <button class="stat-btn suit ${st.suit === false ? 'inactive' : 'active'}" onclick="toggleStat(${idx},'suit')" title="√áelik Yelek">Suit</button>
                            </div>
                            <div class="stat-col">
                                <button class="stat-btn car ${st.car === true ? 'inactive' : 'active'}" onclick="toggleStat(${idx},'car')" title="Araba">Car</button>
                            </div>
                            <div class="stat-col">
                                <button class="stat-btn blood ${st.blood === false ? 'inactive' : 'active'}" onclick="toggleStat(${idx},'blood')" title="Blood Alƒ±m">Blood</button>
                                ${getTimerHtml(idx, st, 'bloodUntil', 'ü©∏')}
                            </div>
                            </div>
                            <div class="stat-col">
                                <button class="stat-btn sh ${st.sh !== false ? 'active' : 'inactive'}" onclick="toggleStat(${idx},'sh')" title="Safe House">SH</button>
                                ${getTimerHtml(idx, st, 'shUntil', 'üè†')}
                            </div>
                            <div class="stat-col">
                                <button class="stat-btn fly ${st.fly !== false ? 'active' : 'inactive'}" onclick="toggleStat(${idx},'fly')" title="Fly Hot">Fly</button>
                                ${getTimerHtml(idx, st, 'flyUntil', '‚úàÔ∏è')}
                            </div>
                        </div>
                    </div>
                    <button class="add-shooter-btn" onclick="openShooterModal(${idx})">+ Shooter</button>
                    <span class="remove-enemy" onclick="removeEnemy(${idx})">√ó</span>
                </div>
                <div class="city-row">
                    <span class="city-label">üìç Last Seen:</span>
                    <select class="city-select" onchange="updateCity(${idx},this.value)">
                        <option value="" ${!st.city ? 'selected' : ''}>Select...</option>
                        <option value="Detroit" ${st.city==='Detroit' ? 'selected' : ''}>Detroit</option>
                        <option value="Chicago" ${st.city==='Chicago' ? 'selected' : ''}>Chicago</option>
                        <option value="New York" ${st.city==='New York' ? 'selected' : ''}>New York</option>
                        <option value="Las Vegas" ${st.city==='Las Vegas' ? 'selected' : ''}>Las Vegas</option>
                        <option value="Philadelphia" ${st.city==='Philadelphia' ? 'selected' : ''}>Philadelphia</option>
                        <option value="Baltimore" ${st.city==='Baltimore' ? 'selected' : ''}>Baltimore</option>
                        <option value="Corleone" ${st.city==='Corleone' ? 'selected' : ''}>Corleone</option>
                        <option value="Palermo" ${st.city==='Palermo' ? 'selected' : ''}>Palermo</option>
                    </select>
                </div>
                ${shootersHtml ? `<div class="shooter-section">${shootersHtml}</div>` : ''}
            </div>
        `;
    }).join('');
}

function getTimerHtml(idx, st, timerKey, icon) {
    const now = Date.now();
    if (!st[timerKey] || st[timerKey] <= now) return '';
    const remaining = st[timerKey] - now;
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    return `<div class="timer-inline">
        <span class="timer-adj" onclick="adjustTimer(${idx},'${timerKey}',-5)">‚àí</span>
        <span class="timer-text" onclick="editTimer(${idx},'${timerKey}')">${mins}:${String(secs).padStart(2,'0')}</span>
        <span class="timer-adj" onclick="adjustTimer(${idx},'${timerKey}',5)">+</span>
    </div>`;
}

function getTimersHtml(idx, st) {
    const timers = [];
    const now = Date.now();
    
    // Fly timer
    if (st.flyUntil && st.flyUntil > now) {
        const remaining = st.flyUntil - now;
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        timers.push(`<span class="timer-item fly">
            <span class="timer-adj" onclick="adjustTimer(${idx},'flyUntil',-5)">‚àí</span>
            <span class="timer-text" onclick="editTimer(${idx},'flyUntil')">‚úàÔ∏è${mins}:${String(secs).padStart(2,'0')}</span>
            <span class="timer-adj" onclick="adjustTimer(${idx},'flyUntil',5)">+</span>
        </span>`);
    }
    
    // SH timer
    if (st.shUntil && st.shUntil > now) {
        const remaining = st.shUntil - now;
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        timers.push(`<span class="timer-item sh">
            <span class="timer-adj" onclick="adjustTimer(${idx},'shUntil',-5)">‚àí</span>
            <span class="timer-text" onclick="editTimer(${idx},'shUntil')">üè†${mins}:${String(secs).padStart(2,'0')}</span>
            <span class="timer-adj" onclick="adjustTimer(${idx},'shUntil',5)">+</span>
        </span>`);
    }
    
    // Blood timer
    if (st.bloodUntil && st.bloodUntil > now) {
        const remaining = st.bloodUntil - now;
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        timers.push(`<span class="timer-item blood">
            <span class="timer-adj" onclick="adjustTimer(${idx},'bloodUntil',-5)">‚àí</span>
            <span class="timer-text" onclick="editTimer(${idx},'bloodUntil')">ü©∏${mins}:${String(secs).padStart(2,'0')}</span>
            <span class="timer-adj" onclick="adjustTimer(${idx},'bloodUntil',5)">+</span>
        </span>`);
    }
    
    if (!timers.length) return '';
    return `<div class="timers-row">${timers.join('')}</div>`;
}

function adjustTimer(enemyIdx, timerKey, minutes) {
    if (!baskinList[enemyIdx].stats) return;
    const st = baskinList[enemyIdx].stats;
    if (!st[timerKey]) return;
    st[timerKey] += minutes * 60 * 1000;
    if (st[timerKey] <= Date.now()) delete st[timerKey];
    saveState();
    renderBaskinList();
}

function editTimer(enemyIdx, timerKey) {
    if (!baskinList[enemyIdx].stats) return;
    const st = baskinList[enemyIdx].stats;
    if (!st[timerKey]) return;
    const remaining = Math.floor((st[timerKey] - Date.now()) / 60000);
    const newMins = prompt('Timer (dakika):', remaining);
    if (newMins === null) return;
    const mins = parseInt(newMins);
    if (isNaN(mins) || mins <= 0) {
        delete st[timerKey];
    } else {
        st[timerKey] = Date.now() + mins * 60 * 1000;
    }
    saveState();
    renderBaskinList();
}

function cancelTimer(enemyIdx, timerKey) {
    if (!baskinList[enemyIdx].stats) return;
    delete baskinList[enemyIdx].stats[timerKey];
    saveState();
    renderBaskinList();
}

let draggedShooter = null;

function shooterDragStart(e) {
    draggedShooter = {
        enemyIdx: parseInt(e.target.dataset.enemy),
        shooterIdx: parseInt(e.target.dataset.shooter)
    };
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function shooterDragOver(e) {
    e.preventDefault();
    const row = e.target.closest('.shooter-row');
    if (row && draggedShooter) {
        document.querySelectorAll('.shooter-row').forEach(r => r.classList.remove('drag-over'));
        row.classList.add('drag-over');
    }
}

function shooterDrop(e) {
    e.preventDefault();
    const row = e.target.closest('.shooter-row');
    if (!row || !draggedShooter) return;
    const targetEnemy = parseInt(row.dataset.enemy);
    const targetShooter = parseInt(row.dataset.shooter);
    if (draggedShooter.enemyIdx === targetEnemy && draggedShooter.shooterIdx !== targetShooter) {
        const shooters = baskinList[targetEnemy].shooters;
        const [moved] = shooters.splice(draggedShooter.shooterIdx, 1);
        const insertAt = targetShooter > draggedShooter.shooterIdx ? targetShooter : targetShooter;
        shooters.splice(insertAt, 0, moved);
        saveState();
        renderBaskinList();
    }
}

function shooterDragEnd(e) {
    document.querySelectorAll('.shooter-row').forEach(r => {
        r.classList.remove('dragging', 'drag-over');
    });
    draggedShooter = null;
}

function updateStat(enemyIdx, statKey, value) {
    if (!baskinList[enemyIdx].stats) baskinList[enemyIdx].stats = {};
    baskinList[enemyIdx].stats[statKey] = value;
    saveState();
}

function toggleStat(enemyIdx, statKey) {
    if (!baskinList[enemyIdx].stats) baskinList[enemyIdx].stats = {};
    const st = baskinList[enemyIdx].stats;
    
    // Car logic is inverted: true = exploded (inactive), undefined/false = normal (active)
    if (statKey === 'car') {
        st.car = st.car === true ? false : true;
        saveState();
        renderBaskinList();
        return;
    }
    
    const current = st[statKey];
    const wasActive = current !== false;
    st[statKey] = wasActive ? false : true;
    
    // Timer logic: when toggled OFF (was active, now inactive)
    if (wasActive) {
        if (statKey === 'sh') {
            // SH off = 1 hour cooldown
            st.shUntil = Date.now() + (60 * 60 * 1000);
        } else if (statKey === 'blood') {
            // Blood off = 60 min cooldown (adjustable)
            st.bloodUntil = Date.now() + (60 * 60 * 1000);
        } else if (statKey === 'fly') {
            // Fly off = 30 min cooldown
            st.flyUntil = Date.now() + (30 * 60 * 1000);
        }
    } else {
        // Toggled back ON - clear timer
        if (statKey === 'sh') delete st.shUntil;
        if (statKey === 'blood') delete st.bloodUntil;
        if (statKey === 'fly') delete st.flyUntil;
    }
    saveState();
    renderBaskinList();
}

function updateCity(enemyIdx, city) {
    if (!baskinList[enemyIdx].stats) baskinList[enemyIdx].stats = {};
    const oldCity = baskinList[enemyIdx].stats.city;
    baskinList[enemyIdx].stats.city = city;
    // City deƒüi≈üince 30 dk fly cooldown ba≈ülat
    if (city && city !== oldCity) {
        baskinList[enemyIdx].stats.flyUntil = Date.now() + (30 * 60 * 1000); // 30 dakika
    }
    saveState();
    renderBaskinList();
}

function getFlyStatus(idx, st) {
    if (!st.flyUntil) return '<div class="fly-status"><span class="can-fly yes">‚úàÔ∏è Can Fly</span></div>';
    const remaining = st.flyUntil - Date.now();
    if (remaining <= 0) return '<div class="fly-status"><span class="can-fly yes">‚úàÔ∏è Can Fly</span></div>';
    const mins = Math.floor(remaining / 60000);
    const secs = Math.floor((remaining % 60000) / 1000);
    return `<div class="fly-status"><span class="can-fly no" onclick="cancelFlyTimer(${idx})" style="cursor:pointer" title="Click to cancel">‚úàÔ∏è No Fly</span><span class="fly-timer">${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}</span></div>`;
}

function cancelFlyTimer(enemyIdx) {
    if (!baskinList[enemyIdx].stats) return;
    delete baskinList[enemyIdx].stats.flyUntil;
    saveState();
    renderBaskinList();
}

// Timer'larƒ± g√ºncelle
setInterval(() => {
    const hasActiveTimers = baskinList.some(item => {
        const st = item.stats || {};
        const now = Date.now();
        return (st.flyUntil > now) || (st.shUntil > now) || (st.bloodUntil > now);
    });
    if (hasActiveTimers) renderBaskinList();
}, 1000);

function updateShooterBg(enemyIdx, shooterIdx, bgType, value) {
    baskinList[enemyIdx].shooters[shooterIdx][bgType] = parseFloat(value) || 0;
    saveState();
}

function toggleHit(enemyIdx, shooterIdx, hitType) {
    const shooter = baskinList[enemyIdx].shooters[shooterIdx];
    if (!shooter.hits) shooter.hits = {};
    shooter.hits[hitType] = !shooter.hits[hitType];
    recalculateFromHits(enemyIdx);
    saveState();
    renderBaskinList();
}

function setBgHit(enemyIdx, shooterIdx, value) {
    const shooter = baskinList[enemyIdx].shooters[shooterIdx];
    if (!shooter.hits) shooter.hits = {};
    shooter.hits.bg = parseInt(value) || 0;
    recalculateFromHits(enemyIdx);
    saveState();
    renderBaskinList();
}

function recalculateFromHits(enemyIdx) {
    const item = baskinList[enemyIdx];
    if (!item.stats) item.stats = {};
    
    let totalBgDead = 0;
    let suitHit = false;
    let carHit = false;
    let bloodHit = false;
    
    (item.shooters || []).forEach(s => {
        const hits = s.hits || {};
        totalBgDead += (parseInt(hits.bg) || 0);
        if (hits.suit) suitHit = true;
        if (hits.car) carHit = true;
        if (hits.blood) bloodHit = true;
    });
    
    item.stats.bgDead = Math.min(totalBgDead, 5);
    if (suitHit) item.stats.suit = false;
    if (carHit) item.stats.car = true;
    if (bloodHit) item.stats.blood = false;
}

const bgDefaults = [
    {name:'V', atk:10, def:0},
    {name:'X', atk:10, def:0},
    {name:'J', atk:5, def:5},
    {name:'I', atk:5, def:5},
    {name:'R', atk:0, def:10},
    {name:'L', atk:0, def:10}
];

function enableBg(enemyIdx, shooterIdx, bgIdx) {
    const shooter = baskinList[enemyIdx].shooters[shooterIdx];
    if (!shooter.bgs) shooter.bgs = {};
    const activeCount = Object.keys(shooter.bgs).length;
    if (activeCount >= 5) {
        alert('Max 5 BG!');
        return;
    }
    const def = bgDefaults[bgIdx];
    shooter.bgs[bgIdx] = { atk: def.atk, def: def.def };
    saveState();
    renderBaskinList();
}

function cycleTargetBg(enemyIdx) {
    if (!baskinList[enemyIdx].stats) baskinList[enemyIdx].stats = {};
    const st = baskinList[enemyIdx].stats;
    const current = st.bgDead || 0;
    st.bgDead = current >= 5 ? 0 : current + 1;
    saveState();
    renderBaskinList();
}

function cycleTargetBgBack(enemyIdx) {
    if (!baskinList[enemyIdx].stats) baskinList[enemyIdx].stats = {};
    const st = baskinList[enemyIdx].stats;
    const current = st.bgDead || 0;
    st.bgDead = current <= 0 ? 5 : current - 1;
    saveState();
    renderBaskinList();
}

function disableBg(enemyIdx, shooterIdx, bgIdx) {
    const shooter = baskinList[enemyIdx].shooters[shooterIdx];
    if (shooter.bgs && shooter.bgs[bgIdx] !== undefined) {
        delete shooter.bgs[bgIdx];
    }
    saveState();
    renderBaskinList();
}

function bgClick(event, enemyIdx, shooterIdx, bgIdx) {
    // Shift+click = disable
    if (event.shiftKey) {
        disableBg(enemyIdx, shooterIdx, bgIdx);
        return;
    }
    cycleBg(enemyIdx, shooterIdx, bgIdx);
}

function cycleBg(enemyIdx, shooterIdx, bgIdx) {
    const shooter = baskinList[enemyIdx].shooters[shooterIdx];
    if (!shooter.bgs || shooter.bgs[bgIdx] === undefined) return;
    const bg = shooter.bgs[bgIdx];
    // ATK up, DEF down, wrap around
    bg.atk = (bg.atk + 1) % 11;
    bg.def = 10 - bg.atk;
    saveState();
    renderBaskinList();
}

function presetBgs(enemyIdx, shooterIdx, preset) {
    const shooter = baskinList[enemyIdx].shooters[shooterIdx];
    if (!shooter.bgs) return;
    Object.keys(shooter.bgs).forEach(key => {
        if (preset === 'atk') {
            shooter.bgs[key] = { atk: 10, def: 0 };
        } else if (preset === 'def') {
            shooter.bgs[key] = { atk: 0, def: 10 };
        } else {
            shooter.bgs[key] = { atk: 5, def: 5 };
        }
    });
    saveState();
    renderBaskinList();
}

function addEnemy(player) {
    if (baskinList.some(b => b.enemy.Name === player.Name)) return;
    baskinList.push({ enemy: player, shooters: [] });
    renderBaskinList();
    document.getElementById('enemySearch').value = '';
    document.getElementById('enemyDropdown').classList.remove('show');
}

function addFamily(familyName) {
    const members = allPlayers.filter(p => p.Family === familyName)
        .sort((a, b) => (a.Pos || 9999) - (b.Pos || 9999));
    let addedCount = 0;
    members.forEach(player => {
        if (!baskinList.some(b => b.enemy.Name === player.Name)) {
            baskinList.push({ enemy: player, shooters: [] });
            addedCount++;
        }
    });
    renderBaskinList();
    document.getElementById('familySearch').value = '';
    document.getElementById('familyDropdown').classList.remove('show');
    if (addedCount > 0) {
        alert(`${addedCount} members from ${familyName} added!`);
    }
}

function removeEnemy(idx) {
    baskinList.splice(idx, 1);
    renderBaskinList();
}

function removeFamily(familyName) {
    const before = baskinList.length;
    baskinList = baskinList.filter(b => b.enemy.Family !== familyName);
    const removed = before - baskinList.length;
    renderBaskinList();
    if (removed > 0) alert(`${familyName} ailesinden ${removed} ki≈üi silindi!`);
}

function openShooterModal(enemyIdx) {
    currentEnemyIdx = enemyIdx;
    document.getElementById('shooterModal').classList.add('show');
    document.getElementById('shooterSearch').value = '';
    renderShooterList('');
    document.getElementById('shooterSearch').focus();
}

function closeShooterModal() {
    document.getElementById('shooterModal').classList.remove('show');
    currentEnemyIdx = null;
}

function renderShooterList(query) {
    const q = (query || '').toLowerCase().trim();
    const filtered = allPlayers.filter(p => {
        const name = (p.Name || '').toLowerCase();
        const fam = (p.Family || '').toLowerCase();
        if (!q) return true;
        return name.includes(q) || fam.includes(q);
    }).sort((a,b) => (a.Pos || 9999) - (b.Pos || 9999)).slice(0, 50);
    
    document.getElementById('shooterList').innerHTML = filtered.map(p => `
        <div class="modal-item" onclick="addShooter('${(p.Name || '').replace(/'/g, "\'")}')">
            ${posHtml(p.Pos)}
            <strong>${p.Name}</strong>
            <span style="color:#94a3b8">${p.Family} ${p.Rank || ''}</span>
        </div>
    `).join('');
}

function addShooter(name) {
    if (currentEnemyIdx === null) return;
    const player = allPlayers.find(p => p.Name === name);
    if (!player) return;
    
    const item = baskinList[currentEnemyIdx];
    if (item.shooters.some(s => s.Name === name)) {
        closeShooterModal();
        return;
    }
    
    // Add shooter with default BG setup
    const newShooter = { ...player, bgs: {
        0: { atk: 10, def: 0 },  // Vic
        1: { atk: 5, def: 5 },   // Lex
        2: { atk: 0, def: 10 },  // Joe
        3: { atk: 0, def: 10 },  // Ike
        4: { atk: 0, def: 10 }   // Lee
        // Ray (5) is inactive
    } };
    item.shooters.push(newShooter);
    renderBaskinList();
    closeShooterModal();
}

function removeShooter(enemyIdx, shooterIdx) {
    baskinList[enemyIdx].shooters.splice(shooterIdx, 1);
    renderBaskinList();
}

function saveState() {
    const state = { baskinList };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState() {
    try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const state = JSON.parse(saved);
            baskinList = state.baskinList || [];
            renderBaskinList();
        }
    } catch(e) { console.error(e); }
}

function copyBaskinList() {
    if (!baskinList.length) {
        alert('Liste bo≈ü!');
        return;
    }
    
    const lines = baskinList.map(item => {
        const e = item.enemy;
        const posStr = e.Pos && e.Pos < 9000 ? `#${e.Pos} ` : '';
        const shooters = item.shooters.map(s => s.Name).join(', ') || 'shooter yok';
        return `${posStr}${e.Name} (${e.Family}) ‚Üê ${shooters}`;
    });
    
    const text = `üéØ Baskƒ±n Listesi\n${lines.join('\n')}`;
    navigator.clipboard.writeText(text).then(() => alert('Kopyalandƒ±!'));
}

// Family search
const familySearch = document.getElementById('familySearch');
const familyDropdown = document.getElementById('familyDropdown');
const allFamilies = [...new Set(allPlayers.map(p => p.Family).filter(f => f && f !== '-'))].sort();

familySearch.addEventListener('input', (e) => {
    const q = (e.target.value || '').toLowerCase().trim();
    if (q.length < 1) {
        familyDropdown.classList.remove('show');
        return;
    }
    
    const filtered = allFamilies.filter(f => f.toLowerCase().includes(q)).slice(0, 15);
    
    familyDropdown.innerHTML = filtered.map(fam => {
        const count = allPlayers.filter(p => p.Family === fam).length;
        const inList = baskinList.filter(b => b.enemy.Family === fam).length;
        const addBtn = `<span onclick="event.stopPropagation();addFamily('${fam}')" style="cursor:pointer;padding:4px 8px;background:#22c55e;border-radius:4px;margin-left:8px;">+Ekle</span>`;
        const delBtn = inList > 0 ? `<span onclick="event.stopPropagation();removeFamily('${fam}')" style="cursor:pointer;padding:4px 8px;background:#ef4444;border-radius:4px;margin-left:4px;">-Sil (${inList})</span>` : '';
        return `<div class="player-option" style="justify-content:space-between;">
            <div><strong>üè† ${fam}</strong> <span style="color:#94a3b8">(${count} √ºye)</span></div>
            <div>${addBtn}${delBtn}</div>
        </div>`;
    }).join('');
    
    familyDropdown.classList.add('show');
});

// Enemy search
const enemySearch = document.getElementById('enemySearch');
const enemyDropdown = document.getElementById('enemyDropdown');

enemySearch.addEventListener('input', (e) => {
    const q = (e.target.value || '').toLowerCase().trim();
    if (q.length < 1) {
        enemyDropdown.classList.remove('show');
        return;
    }
    
    const filtered = allPlayers.filter(p => {
        const name = (p.Name || '').toLowerCase();
        const fam = (p.Family || '').toLowerCase();
        return name.includes(q) || fam.includes(q);
    }).sort((a,b) => (a.Pos || 9999) - (b.Pos || 9999)).slice(0, 30);
    
    enemyDropdown.innerHTML = filtered.map(p => `
        <div class="player-option" onclick="addEnemy(${JSON.stringify(p).replace(/"/g, '&quot;')})">
            ${posHtml(p.Pos)}
            <strong>${p.Name}</strong>
            <span style="color:#94a3b8">${p.Family} ${p.Rank}</span>
        </div>
    `).join('');
    
    enemyDropdown.classList.add('show');
});

document.getElementById('shooterSearch').addEventListener('input', (e) => {
    renderShooterList(e.target.value);
});

document.getElementById('shooterModal').addEventListener('click', (e) => {
    if (e.target.id === 'shooterModal') closeShooterModal();
});

document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-wrap')) {
        enemyDropdown.classList.remove('show');
        familyDropdown.classList.remove('show');
    }
});

// Load on start
loadState();
</script>
</body></html>